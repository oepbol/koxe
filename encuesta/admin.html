<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-section {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .request-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background-color: #f8f9fa;
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .request-info {
            margin-bottom: 10px;
        }
        
        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-approve {
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-reject {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .status-pendiente { background-color: #ffc107; color: #212529; }
        .status-aprobado { background-color: #28a745; color: white; }
        .status-rechazado { background-color: #dc3545; color: white; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .collaborator-card {
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background-color: #f8fff9;
        }
        
        .collaborator-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-remove {
            background-color: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>

<div id="admin-login-container" class="login-container">
    <div class="login-box">
        <h2>Acceso de Administrador</h2>
        <form id="admin-login-form">
            <input type="email" id="admin-email" placeholder="Email de administrador" required>
            <input type="password" id="admin-password" placeholder="Contraseña" required>
            <button type="submit">Ingresar</button>
            <p id="admin-login-error" class="login-error"></p>
        </form>
    </div>
</div>

<div class="main-wrapper" id="admin-content" style="display: none;">
    <div class="container">
        <h1>Panel de Administración</h1>
        <p class="subtitle">Gestión de colaboradores y monitoreo del sistema</p>
        
        <!-- Estadísticas Generales -->
        <div class="admin-section">
            <h2>Estadísticas Generales</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="stat-requests">0</div>
                    <div>Solicitudes Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-approved">0</div>
                    <div>Colaboradores Aprobados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-votes">0</div>
                    <div>Votos Oficiales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-collab-votes">0</div>
                    <div>Votos Colaborativos</div>
                </div>
            </div>
        </div>

        <!-- Solicitudes Pendientes -->
        <div class="admin-section">
            <h2>Solicitudes de Colaboradores</h2>
            <div id="requests-container">
                <div class="loading">Cargando solicitudes...</div>
            </div>
        </div>

        <!-- Colaboradores Aprobados -->
        <div class="admin-section">
            <h2>Colaboradores Aprobados</h2>
            <div id="approved-container">
                <div class="loading">Cargando colaboradores...</div>
            </div>
        </div>

        <!-- Panel de Control de Base de Datos -->
        <div class="admin-section">
            <h2>Control de Base de Datos</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <button class="admin-button" onclick="resetOfficialVotes()">
                    Resetear Votos Oficiales
                </button>
                <button class="admin-button" onclick="resetCollaborativeVotes()">
                    Resetear Votos Colaborativos
                </button>
                <button class="admin-button" onclick="exportData()">
                    Exportar Datos
                </button>
            </div>
            <div id="admin-status" class="admin-status"></div>
        </div>
    </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

<script>
    // Configuración Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCBD-xQh9223xKez9wBqK2KJOGqF9yZjFo",
        authDomain: "encuesta-f2a28.firebaseapp.com",
        databaseURL: "https://encuesta-f2a28-default-rtdb.firebaseio.com",
        projectId: "encuesta-f2a28",
        storageBucket: "encuesta-f2a28.appspot.com",
        messagingSenderId: "491969168385",
        appId: "1:491969168385:web:f7b989b9aaf8562fd7ac00"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    const requestsRef = database.ref('collaboration_requests');
    const approvedRef = database.ref('approved_collaborators');
    const votesRef = database.ref('votes');
    const collabVotesRef = database.ref('collaborative_votes');

    let currentUser = null;

    // Login de administrador
    document.getElementById('admin-login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        const errorEl = document.getElementById('admin-login-error');
        
        errorEl.textContent = '';
        
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                currentUser = userCredential.user;
                document.getElementById('admin-login-container').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                
                // Cargar datos del panel
                loadDashboardData();
            })
            .catch((error) => {
                errorEl.textContent = 'Credenciales de administrador incorrectas.';
                console.error('Error de autenticación:', error);
            });
    });

    function loadDashboardData() {
        loadStatistics();
        loadRequests();
        loadApprovedCollaborators();
    }

    function loadStatistics() {
        // Cargar estadísticas
        requestsRef.orderByChild('status').equalTo('PENDIENTE').once('value', (snapshot) => {
            document.getElementById('stat-requests').textContent = snapshot.numChildren();
        });

        approvedRef.once('value', (snapshot) => {
            document.getElementById('stat-approved').textContent = snapshot.numChildren();
        });

        votesRef.once('value', (snapshot) => {
            const data = snapshot.val() || {};
            const total = Object.values(data).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('stat-votes').textContent = total;
        });

        collabVotesRef.once('value', (snapshot) => {
            let total = 0;
            snapshot.forEach((childSnapshot) => {
                const votes = childSnapshot.val();
                total += Object.values(votes).reduce((sum, val) => sum + (val || 0), 0);
            });
            document.getElementById('stat-collab-votes').textContent = total;
        });
    }

    function loadRequests() {
        const container = document.getElementById('requests-container');
        
        requestsRef.orderByChild('timestamp').once('value', (snapshot) => {
            container.innerHTML = '';
            
            if (!snapshot.exists()) {
                container.innerHTML = '<p>No hay solicitudes pendientes.</p>';
                return;
            }

            snapshot.forEach((childSnapshot) => {
                const request = childSnapshot.val();
                const requestId = childSnapshot.key;
                
                const card = createRequestCard(request, requestId);
                container.appendChild(card);
            });
        });
    }

    function createRequestCard(request, requestId) {
        const card = document.createElement('div');
        card.className = 'request-card';
        
        const statusClass = `status-${request.status.toLowerCase()}`;
        
        card.innerHTML = `
            <div class="request-header">
                <h3>${request.nombre}</h3>
                <span class="status-badge ${statusClass}">${request.status}</span>
            </div>
            <div class="request-info">
                <strong>Email:</strong> ${request.email}<br>
                <strong>Teléfono:</strong> ${request.telefono}<br>
                <strong>Ubicación:</strong> ${request.provincia}, ${request.departamento}<br>
                <strong>Disponibilidad:</strong> ${request.disponibilidad}<br>
                <strong>Fecha de solicitud:</strong> ${new Date(request.timestamp).toLocaleDateString()}
            </div>
            ${request.experiencia ? `<p><strong>Experiencia:</strong> ${request.experiencia}</p>` : ''}
            <p><strong>Motivación:</strong> ${request.motivacion}</p>
            ${request.redes ? `<p><strong>Redes sociales:</strong> <a href="${request.redes}" target="_blank">${request.redes}</a></p>` : ''}
            
            ${request.status === 'PENDIENTE' ? `
                <div class="request-actions">
                    <button class="btn-approve" onclick="approveRequest('${requestId}')">
                        Aprobar Colaborador
                    </button>
                    <button class="btn-reject" onclick="rejectRequest('${requestId}')">
                        Rechazar Solicitud
                    </button>
                </div>
            ` : ''}
        `;
        
        return card;
    }

    function approveRequest(requestId) {
        if (!confirm('¿Está seguro de aprobar este colaborador?')) return;

        requestsRef.child(requestId).once('value', (snapshot) => {
            const request = snapshot.val();
            
            // Crear entrada en colaboradores aprobados
            const collaboratorData = {
                ...request,
                status: 'APROBADO',
                fecha_aprobacion: new Date().toISOString(),
                aprobado_por: currentUser.email
            };
            
            // Generar credenciales de acceso únicas
            const collaboratorId = generateCollaboratorId(request.nombre, request.departamento);
            collaboratorData.collaborator_id = collaboratorId;
            collaboratorData.access_code = generateAccessCode();
            
            // Guardar en colaboradores aprobados
            approvedRef.child(collaboratorId).set(collaboratorData)
                .then(() => {
                    // Actualizar estado de la solicitud
                    return requestsRef.child(requestId).update({ status: 'APROBADO' });
                })
                .then(() => {
                    alert(`Colaborador aprobado exitosamente.\nID: ${collaboratorId}\nCódigo de acceso: ${collaboratorData.access_code}`);
                    loadDashboardData(); // Recargar datos
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Error al aprobar colaborador');
                });
        });
    }

    function rejectRequest(requestId) {
        if (!confirm('¿Está seguro de rechazar esta solicitud?')) return;

        requestsRef.child(requestId).update({ status: 'RECHAZADO' })
            .then(() => {
                loadDashboardData(); // Recargar datos
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error al rechazar solicitud');
            });
    }

    function loadApprovedCollaborators() {
        const container = document.getElementById('approved-container');
        
        approvedRef.once('value', (snapshot) => {
            container.innerHTML = '';
            
            if (!snapshot.exists()) {
                container.innerHTML = '<p>No hay colaboradores aprobados.</p>';
                return;
            }

            snapshot.forEach((childSnapshot) => {
                const collaborator = childSnapshot.val();
                const collaboratorId = childSnapshot.key;
                
                const card = createCollaboratorCard(collaborator, collaboratorId);
                container.appendChild(card);
            });
        });
    }

    function createCollaboratorCard(collaborator, collaboratorId) {
        const card = document.createElement('div');
        card.className = 'collaborator-card';
        
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>${collaborator.nombre}</h3>
                <span style="font-size: 0.9em; color: #666;">ID: ${collaboratorId}</span>
            </div>
            <p><strong>Ubicación:</strong> ${collaborator.provincia}, ${collaborator.departamento}</p>
            <p><strong>Email:</strong> ${collaborator.email}</p>
            <p><strong>Código de acceso:</strong> <code>${collaborator.access_code}</code></p>
            <p><strong>Aprobado:</strong> ${new Date(collaborator.fecha_aprobacion).toLocaleDateString()}</p>
            
            <div class="collaborator-actions">
                <button class="btn-remove" onclick="removeCollaborator('${collaboratorId}')">
                    Revocar Acceso
                </button>
            </div>
        `;
        
        return card;
    }

    function removeCollaborator(collaboratorId) {
        if (!confirm('¿Está seguro de revocar el acceso de este colaborador?')) return;

        approvedRef.child(collaboratorId).remove()
            .then(() => {
                loadDashboardData(); // Recargar datos
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error al revocar acceso');
            });
    }

    // Funciones de utilidad
    function generateCollaboratorId(name, department) {
        const cleanName = name.replace(/\s+/g, '').substring(0, 6).toUpperCase();
        const cleanDept = department.substring(0, 3).toUpperCase();
        const timestamp = Date.now().toString().slice(-4);
        return `${cleanName}_${cleanDept}_${timestamp}`;
    }

    function generateAccessCode() {
        return Math.random().toString(36).substring(2, 10).toUpperCase();
    }

    // Funciones del panel de control
    function resetOfficialVotes() {
        if (!confirm('¿Está seguro de resetear TODOS los votos oficiales?')) return;
        
        const resetData = {
            candidato_a: 0,
            candidato_b: 0,
            blancos: 0,
            nulos: 0,
            nsnr: 0
        };
        
        votesRef.set(resetData)
            .then(() => {
                document.getElementById('admin-status').innerHTML = 
                    '<div style="color: green;">Votos oficiales reseteados exitosamente.</div>';
                loadStatistics();
            })
            .catch((error) => {
                console.error('Error:', error);
                document.getElementById('admin-status').innerHTML = 
                    '<div style="color: red;">Error al resetear votos oficiales.</div>';
            });
    }

    function resetCollaborativeVotes() {
        if (!confirm('¿Está seguro de resetear TODOS los votos colaborativos?')) return;
        
        collabVotesRef.remove()
            .then(() => {
                document.getElementById('admin-status').innerHTML = 
                    '<div style="color: green;">Votos colaborativos reseteados exitosamente.</div>';
                loadStatistics();
            })
            .catch((error) => {
                console.error('Error:', error);
                document.getElementById('admin-status').innerHTML = 
                    '<div style="color: red;">Error al resetear votos colaborativos.</div>';
            });
    }

    function exportData() {
        // Exportar todos los datos importantes
        const exportData = {};
        
        Promise.all([
            votesRef.once('value'),
            collabVotesRef.once('value'),
            requestsRef.once('value'),
            approvedRef.once('value')
        ]).then(([votes, collabVotes, requests, approved]) => {
            exportData.official_votes = votes.val();
            exportData.collaborative_votes = collabVotes.val();
            exportData.collaboration_requests = requests.val();
            exportData.approved_collaborators = approved.val();
            exportData.export_date = new Date().toISOString();
            
            // Crear archivo de descarga
            const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `encuesta_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            document.getElementById('admin-status').innerHTML = 
                '<div style="color: green;">Datos exportados exitosamente.</div>';
        });
    }
</script>

</body>
</html>